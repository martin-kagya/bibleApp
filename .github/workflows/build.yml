name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]

    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Free Disk Space
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            sudo rm -rf /usr/share/dotnet
            sudo rm -rf /opt/ghc
            sudo rm -rf "/usr/local/share/boost"
            sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          elif [ "${{ runner.os }}" == "macOS" ]; then
            sudo rm -rf /Applications/Xcode_15.2.app
            sudo rm -rf /Applications/Xcode_15.1.app
          fi

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install macOS build dependencies
        if: matrix.os == 'macos-latest'
        run: brew install libomp

      - name: Install Windows build dependencies
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          vcpkg install openblas:x64-windows lapack:x64-windows
          # Add to both shell and future steps
          echo "CMAKE_PREFIX_PATH=$VCPKG_INSTALLATION_ROOT/installed/x64-windows" >> $GITHUB_ENV
          echo "VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT" >> $GITHUB_ENV
          # Explicitly point to the libraries for cmake-js
          echo "BLAS_LIBRARIES=$VCPKG_INSTALLATION_ROOT/installed/x64-windows/lib/openblas.lib" >> $GITHUB_ENV
          echo "LAPACK_LIBRARIES=$VCPKG_INSTALLATION_ROOT/installed/x64-windows/lib/openblas.lib" >> $GITHUB_ENV

      - name: Cleanup Lingering Processes (Windows)
        if: matrix.os == 'windows-latest'
        continue-on-error: true
        shell: pwsh
        run: |
          Get-Process -Name "node", "electron" -ErrorAction SilentlyContinue | Stop-Process -Force
          rm -rf node_modules/.bin/electron.cmd

      - name: Install dependencies
        shell: bash
        run: npm install --legacy-peer-deps
        env:
          PYTHON: python
          npm_config_python: python
          npm_config_runtime: electron
          npm_config_target: 39.2.6
          npm_config_disturl: https://electronjs.org/headers
          npm_config_build_from_source: true

      - name: Download Large Assets
        shell: bash
        run: |
          mkdir -p data models
          function gdrive_download() {
            local id=$(echo "$1" | sed -E 's/.*id=([^&]*).*/\1/; s/.*\/d\/([^/]*).*/\1/')
            local output="$2"
            echo "Downloading Google Drive ID: $id"
            local COOKIE_FILE="./cookies.txt"
            curl -sL --cookie-jar "$COOKIE_FILE" "https://docs.google.com/uc?export=download&id=${id}" -o confirm_page.html
            local confirm=$(grep -oE 'name="confirm" value="[^"]+"' confirm_page.html | head -1 | cut -d'"' -f4)
            local uuid=$(grep -oE 'name="uuid" value="[^"]+"' confirm_page.html | head -1 | cut -d'"' -f4)
            if [ -n "$confirm" ]; then
              local dl_url="https://drive.usercontent.google.com/download?id=${id}&export=download&confirm=${confirm}"
              [ -n "$uuid" ] && dl_url="${dl_url}&uuid=${uuid}"
              curl -sL --cookie "$COOKIE_FILE" "$dl_url" -o "$output"
            else
              curl -sL --cookie "$COOKIE_FILE" "https://docs.google.com/uc?export=download&id=${id}" -o "$output"
            fi
            rm -f confirm_page.html "$COOKIE_FILE"
            
            local size=$(wc -c < "$output" | tr -d ' ')
            if [ "$size" -lt 1000000 ]; then
              echo "ERROR: Downloaded file too small ($size bytes)."
              return 1
            fi
          }
          gdrive_download "${{ secrets.DATA_URL }}" "data.zip"
          unzip -o data.zip
          gdrive_download "${{ secrets.MODELS_URL }}" "models.zip"
          unzip -o models.zip
          rm data.zip models.zip

      - name: Build Web App
        run: npm run build

      - name: Build/Release Electron App
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release: true
          # Skip build as we already did it manually
          skip_build: true
        env:
          PYTHON: python
          npm_config_python: python
          npm_config_runtime: electron
          npm_config_target: 39.2.6
          npm_config_disturl: https://electronjs.org/headers
          npm_config_build_from_source: true
