name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install macOS build dependencies
        if: matrix.os == 'macos-latest'
        run: brew install libomp

      - name: Install dependencies
        shell: bash
        run: npm install --legacy-peer-deps
        env:
          PYTHON: python
          npm_config_python: python
          npm_config_runtime: electron
          npm_config_target: 39.2.6
          npm_config_disturl: https://electronjs.org/headers
          npm_config_build_from_source: true

      # OMITTED BY DEFAULT: GitHub Actions doesn't have your 2GB data files.
      # To enable CI builds, upload your data/ and models/ to a cloud provider 
      # and uncomment this section.
      - name: Download Large Assets
        shell: bash
        run: |
          mkdir -p data models
          function gdrive_download() {
            local id=$(echo "$1" | sed -E 's/.*id=([^&]*).*/\1/; s/.*\/d\/([^/]*).*/\1/')
            local output="$2"
            echo "Downloading Google Drive ID: $id"
            
            local COOKIE_FILE="./cookies.txt"
            
            # Step 1: Get the virus warning page and keep cookies
            curl -sL --cookie-jar "$COOKIE_FILE" "https://docs.google.com/uc?export=download&id=${id}" -o confirm_page.html
            
            # Step 2: Extract both 'confirm' and 'uuid' from the form
            local confirm=$(grep -oE 'name="confirm" value="[^"]+"' confirm_page.html | head -1 | cut -d'"' -f4)
            local uuid=$(grep -oE 'name="uuid" value="[^"]+"' confirm_page.html | head -1 | cut -d'"' -f4)
            
            echo "Confirmation: $confirm, UUID: $uuid"
            
            # Step 3: Perform actual download using the drive.usercontent.google.com endpoint
            if [ -n "$confirm" ]; then
              local dl_url="https://drive.usercontent.google.com/download?id=${id}&export=download&confirm=${confirm}"
              if [ -n "$uuid" ]; then
                dl_url="${dl_url}&uuid=${uuid}"
              fi
              curl -sL --cookie "$COOKIE_FILE" "$dl_url" -o "$output"
            else
              curl -sL --cookie "$COOKIE_FILE" "https://docs.google.com/uc?export=download&id=${id}" -o "$output"
            fi
            
            # Cleanup
            rm -f confirm_page.html "$COOKIE_FILE"
            
            # Verify file size (should be > 1MB)
            local size=$(wc -c < "$output" | tr -d ' ')
            if [ "$size" -lt 1000000 ]; then
              echo "ERROR: Downloaded file is too small ($size bytes). Content:"
              head -n 20 "$output"
              return 1
            fi
            echo "Successfully downloaded $(basename "$output") ($size bytes)"
          }
          
          gdrive_download "${{ secrets.DATA_URL }}" "data/bible_data.zip"
          unzip -o data/bible_data.zip -d data/
          gdrive_download "${{ secrets.MODELS_URL }}" "models/models.zip"
          unzip -o models/models.zip -d models/

      - name: Build Web App
        run: npm run build

      - name: Build/Release Electron App
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release: true
          # Note: macOS builds will not be signed unless certificates are provided in secrets
