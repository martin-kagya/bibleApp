name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]

    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Free Disk Space
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            sudo rm -rf /usr/share/dotnet
            sudo rm -rf /opt/ghc
            sudo rm -rf "/usr/local/share/boost"
            sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          elif [ "${{ runner.os }}" == "macOS" ]; then
            sudo rm -rf /Applications/Xcode_15.2.app
            sudo rm -rf /Applications/Xcode_15.1.app
          fi

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install macOS build dependencies
        if: matrix.os == 'macos-latest'
        run: brew install libomp

      - name: Install Windows build dependencies
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          vcpkg install openblas:x64-windows lapack:x64-windows
          # Add to both shell and future steps
          echo "CMAKE_PREFIX_PATH=$VCPKG_INSTALLATION_ROOT/installed/x64-windows" >> $GITHUB_ENV
          echo "VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT" >> $GITHUB_ENV
          # Explicitly point to the libraries for cmake-js
          echo "BLAS_LIBRARIES=$VCPKG_INSTALLATION_ROOT/installed/x64-windows/lib/openblas.lib" >> $GITHUB_ENV
          echo "LAPACK_LIBRARIES=$VCPKG_INSTALLATION_ROOT/installed/x64-windows/lib/openblas.lib" >> $GITHUB_ENV

      - name: Cleanup Lingering Processes (Windows)
        if: matrix.os == 'windows-latest'
        continue-on-error: true
        shell: pwsh
        run: |
          Get-Process -Name "node", "electron" -ErrorAction SilentlyContinue | Stop-Process -Force
          if (Test-Path "node_modules/.bin/electron.cmd") { Remove-Item -Path "node_modules/.bin/electron.cmd" -Force -ErrorAction SilentlyContinue }

      - name: Install dependencies
        shell: bash
        run: npm install --legacy-peer-deps
        env:
          PYTHON: python
          npm_config_python: python
          npm_config_runtime: electron
          npm_config_target: 39.2.6
          npm_config_disturl: https://electronjs.org/headers
          npm_config_build_from_source: true

      - name: Download Large Assets
        shell: bash
        run: |
          pip install gdown
          mkdir -p data models
          
          # Download Data
          gdown "${{ secrets.DATA_URL }}" -O data.zip --fuzzy
          unzip -o data.zip -d data_tmp
          if [ -d "data_tmp/data" ]; then cp -rn data_tmp/data/* data/ ; else cp -rn data_tmp/* data/ ; fi
          
          # Download Models
          gdown "${{ secrets.MODELS_URL }}" -O models.zip --fuzzy
          unzip -o models.zip -d models_tmp
          if [ -d "models_tmp/models" ]; then cp -rn models_tmp/models/* models/ ; else cp -rn models_tmp/* models/ ; fi

          # Cleanup
          rm -rf data.zip models.zip data_tmp models_tmp
          
          echo "--- ASSET VERIFICATION ---"
          echo "Data Folder Size:" && du -sh data/
          echo "Models Folder Size:" && du -sh models/

      - name: Build Web App
        run: npm run build

      - name: Build/Release Electron App
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release: true
          # Skip build as we already did it manually
          skip_build: true
        env:
          PYTHON: python
          npm_config_python: python
          npm_config_runtime: electron
          npm_config_target: 39.2.6
          npm_config_disturl: https://electronjs.org/headers
          npm_config_build_from_source: true
